<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام إدارة الانتظار</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cairo:wght@400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        body { font-family: 'Cairo', sans-serif; }
        .gradient-bg { background: linear-gradient(135deg, #11998e 0%, #38ef7d 100%); }
        .pulse-animation { animation: pulse 2s infinite; }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }
        .control-button {
            transition: all 0.3s ease;
            min-height: 80px;
        }
        .control-button:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.2);
        }
        .current-number {
            font-size: 4rem;
            text-shadow: 2px 2px 4px rgba(0, 0, 0, 0.3);
        }
        .notification {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            z-index: 1000;
            opacity: 0;
            transition: opacity 0.3s ease;
        }
        .notification.show {
            opacity: 1;
        }
    </style>
</head>
<body class="gradient-bg min-h-screen">
    <div id="loginModal" class="fixed inset-0 bg-black/50 flex items-center justify-center z-50">
        <div class="bg-white rounded-lg p-8 max-w-md w-full mx-4">
            <div class="text-center mb-6">
                <i class="fas fa-tasks text-4xl text-green-600 mb-4"></i>
                <h2 class="text-2xl font-bold text-gray-800">تسجيل دخول لوحة التحكم</h2>
                <p class="text-gray-600">اختر العيادة وأدخل كلمة المرور</p>
            </div>
            <form id="loginForm">
                <div class="mb-4">
                    <label class="block text-sm font-medium text-gray-700 mb-2">العيادة</label>
                    <select id="clinicSelect" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">اختر العيادة</option>
                    </select>
                </div>
                <div class="mb-6">
                    <label class="block text-sm font-medium text-gray-700 mb-2">كلمة المرور</label>
                    <input type="password" id="controlPassword" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500" placeholder="كلمة مرور التحكم">
                </div>
                <button type="submit" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 transition-colors">
                    <i class="fas fa-sign-in-alt ml-2"></i>الدخول إلى لوحة التحكم
                </button>
            </form>
        </div>
    </div>

    <div id="notification" class="notification bg-white rounded-lg shadow-lg p-4">
        <div class="flex items-center">
            <i class="fas fa-bullhorn text-green-600 text-xl ml-3"></i>
            <span id="notificationText" class="font-bold text-gray-800"></span>
        </div>
    </div>

    <header class="bg-white/10 backdrop-blur-sm border-b border-white/20">
        <div class="container mx-auto px-4 py-4">
            <div class="flex items-center justify-between">
                <div class="flex items-center">
                    <i class="fas fa-tasks text-2xl text-white ml-3"></i>
                    <div>
                        <h1 class="text-xl font-bold text-white" id="clinicName">لوحة التحكم</h1>
                        <p class="text-white/80 text-sm" id="clinicInfo">اختر العيادة للبدء</p>
                    </div>
                </div>
                <div class="flex items-center space-x-4">
                    <div class="text-left">
                        <div class="text-white font-semibold" id="currentTime"></div>
                        <div class="text-white/80 text-sm" id="currentDate"></div>
                    </div>
                    <button onclick="logout()" class="bg-red-600 hover:bg-red-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-sign-out-alt ml-2"></i>خروج
                    </button>
                </div>
            </div>
        </div>
    </header>

    <main class="container mx-auto px-4 py-8" id="mainContent" style="display: none;">
        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-8 mb-8 text-center">
            <h2 class="text-2xl font-bold text-white mb-4">الرقم الحالي</h2>
            <div class="current-number text-yellow-300 pulse-animation" id="currentNumber">0</div>
            <div class="text-white/80 text-lg mt-2" id="lastCalledTime">آخر نداء: --:--</div>
        </div>

        <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-4 mb-8">
            <button onclick="nextClient()" class="control-button bg-blue-600 hover:bg-blue-700 text-white p-4 rounded-lg font-bold">
                <i class="fas fa-arrow-right text-2xl mb-2 block"></i>
                العميل التالي
            </button>
            <button onclick="previousClient()" class="control-button bg-purple-600 hover:bg-purple-700 text-white p-4 rounded-lg font-bold">
                <i class="fas fa-arrow-left text-2xl mb-2 block"></i>
                العميل السابق
            </button>
            <button onclick="repeatCall()" class="control-button bg-orange-600 hover:bg-orange-700 text-white p-4 rounded-lg font-bold">
                <i class="fas fa-redo text-2xl mb-2 block"></i>
                تكرار النداء
            </button>
            <button onclick="resetClinic()" class="control-button bg-red-600 hover:bg-red-700 text-white p-4 rounded-lg font-bold">
                <i class="fas fa-refresh text-2xl mb-2 block"></i>
                تصفير العيادة
            </button>
            <button onclick="callSpecificNumber()" class="control-button bg-indigo-600 hover:bg-indigo-700 text-white p-4 rounded-lg font-bold">
                <i class="fas fa-bullhorn text-2xl mb-2 block"></i>
                نداء رقم محدد
            </button>
            <button onclick="emergencyAlert()" class="control-button bg-gray-800 hover:bg-gray-900 text-white p-4 rounded-lg font-bold">
                <i class="fas fa-exclamation-triangle text-2xl mb-2 block"></i>
                تنبيه طوارئ
            </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-user text-yellow-300 ml-3"></i>
                    نداء باسم العميل
                </h3>
                <div class="flex space-x-2">
                    <input type="text" id="clientName" placeholder="أدخل اسم العميل" class="flex-1 px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="callByName()" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-lg transition-colors">
                        <i class="fas fa-bullhorn"></i>
                    </button>
                </div>
            </div>

            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-exchange-alt text-yellow-300 ml-3"></i>
                    تحويل إلى عيادة أخرى
                </h3>
                <div class="space-y-2">
                    <input type="number" id="transferNumber" placeholder="رقم العميل" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <select id="targetClinic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">اختر العيادة المستهدفة</option>
                    </select>
                    <button onclick="transferClient()" class="w-full bg-blue-600 hover:bg-blue-700 text-white py-2 rounded-lg transition-colors">
                        تحويل العميل
                    </button>
                </div>
            </div>

            <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
                <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-bell text-yellow-300 ml-3"></i>
                    تنبيه طبيب
                </h3>
                <div class="space-y-2">
                    <select id="targetDoctorClinic" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                        <option value="">اختر عيادة الطبيب</option>
                    </select>
                    <input type="text" id="doctorMessage" placeholder="نص التنبيه" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-green-500">
                    <button onclick="sendDoctorAlert()" class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg transition-colors">
                        إرسال التنبيه
                    </button>
                </div>
            </div>
        </div>

        <div class="bg-white/10 backdrop-blur-sm rounded-lg p-6">
            <h3 class="text-lg font-bold text-white mb-4 flex items-center">
                <i class="fas fa-power-off text-yellow-300 ml-3"></i>
                التحكم في حالة العيادة
            </h3>
            <div class="flex space-x-4">
                <button onclick="pauseClinic()" id="pauseBtn" class="bg-red-600 hover:bg-red-700 text-white px-6 py-3 rounded-lg font-bold transition-colors">
                    <i class="fas fa-pause ml-2"></i>إيقاف العيادة
                </button>
                <button onclick="resumeClinic()" id="resumeBtn" class="bg-green-600 hover:bg-green-700 text-white px-6 py-3 rounded-lg font-bold transition-colors" style="display: none;">
                    <i class="fas fa-play ml-2"></i>استئناف العيادة
                </button>
            </div>
        </div>
    </main>
    
    <audio id="audioPlayer" preload="auto"></audio>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
        import { getDatabase, ref, onValue, set, push, get } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js";

        // Firebase configuration
// For Firebase JS SDK v7.20.0 and later, measurementId is optional
const firebaseConfig = {
  apiKey: "AIzaSyCpgAJGWXAPN87CfBHI7cxA44NHjpSeOI4",
  authDomain: "queue3-1c1a4.firebaseapp.com",
  databaseURL: "https://queue3-1c1a4-default-rtdb.firebaseio.com",
  projectId: "queue3-1c1a4",
  storageBucket: "queue3-1c1a4.firebasestorage.app",
  messagingSenderId: "766611607574",
  appId: "1:766611607574:web:c0ee754f7324adc853a537",
  measurementId: "G-ZSZ13TYJQW"
};

        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const database = getDatabase(app);

        let currentClinicId = null;
        let currentClinic = null;
        let isLoggedIn = false;
        let audioPath = './audio'; // Default path (Fetched from settings)
        let speechRate = 1; // Default rate (Fetched from settings)


        // Function to load system settings (especially audioPath)
        function loadSystemSettings(callback) {
            const settingsRef = ref(database, 'settings');
            onValue(settingsRef, (snapshot) => {
                const settings = snapshot.val();
                if (settings) {
                    audioPath = settings.audioPath || './audio';
                    speechRate = settings.speechRate || 1;
                }
                if (callback) callback();
            }, { onlyOnce: true });
        }


        // Load clinics for login
        function loadClinicsForLogin() {
            const clinicsRef = ref(database, 'clinics');
            onValue(clinicsRef, (snapshot) => {
                const clinics = snapshot.val();
                const clinicSelect = document.getElementById('clinicSelect');
                const targetSelect = document.getElementById('targetClinic');
                const doctorSelect = document.getElementById('targetDoctorClinic');
                clinicSelect.innerHTML = '<option value="">اختر العيادة</option>';
                targetSelect.innerHTML = '<option value="">اختر العيادة المستهدفة</option>';
                doctorSelect.innerHTML = '<option value="">اختر عيادة الطبيب</option>';
                
                if (clinics) {
                    Object.values(clinics).forEach(clinic => {
                        const option = document.createElement('option');
                        option.value = clinic.number;
                        option.textContent = clinic.name;
                        clinicSelect.appendChild(option);

                        // Populate target clinics lists as well
                        const optionT = document.createElement('option');
                        optionT.value = clinic.number;
                        optionT.textContent = clinic.name;
                        targetSelect.appendChild(optionT);

                        const optionD = document.createElement('option');
                        optionD.value = clinic.number;
                        optionD.textContent = clinic.name;
                        doctorSelect.appendChild(optionD);
                    });
                }
            });
        }

        // Login functionality
        document.getElementById('loginForm').addEventListener('submit', (e) => {
            e.preventDefault();
            const clinicId = document.getElementById('clinicSelect').value;
            const password = document.getElementById('controlPassword').value;
            
            if (!clinicId) {
                alert('يرجى اختيار العيادة');
                return;
            }
            
            // Check control password from settings
            const settingsRef = ref(database, 'settings/controlPassword');
            onValue(settingsRef, (snapshot) => {
                const controlPassword = snapshot.val();
                if (password === controlPassword) {
                    loginToClinic(clinicId);
                } else {
                    alert('كلمة مرور التحكم غير صحيحة');
                }
            }, { onlyOnce: true });
        });

        function loginToClinic(clinicId) {
            currentClinicId = clinicId;
            isLoggedIn = true;
            
            // Load system settings first, then clinic data
            loadSystemSettings(() => {
                const clinicRef = ref(database, `clinics/${clinicId}`);
                onValue(clinicRef, (snapshot) => {
                    currentClinic = snapshot.val();
                    if (currentClinic) {
                        updateDisplay();
                    }
                });
            });
            
            document.getElementById('loginModal').style.display = 'none';
            document.getElementById('mainContent').style.display = 'block';
            
            updateDateTime();
            setInterval(updateDateTime, 1000);
        }

        function updateDisplay() {
            document.getElementById('clinicName').textContent = currentClinic.name;
            document.getElementById('clinicInfo').textContent = `عيادة رقم ${currentClinic.number}`;
            document.getElementById('currentNumber').textContent = currentClinic.currentNumber || 0;
            
            const lastCalled = currentClinic.lastCalled ? new Date(currentClinic.lastCalled).toLocaleTimeString('ar-EG') : '--:--';
            document.getElementById('lastCalledTime').textContent = `آخر نداء: ${lastCalled}`;
            
            // Update status buttons
            if (currentClinic.isActive) {
                document.getElementById('pauseBtn').style.display = 'inline-block';
                document.getElementById('resumeBtn').style.display = 'none';
            } else {
                document.getElementById('pauseBtn').style.display = 'none';
                document.getElementById('resumeBtn').style.display = 'inline-block';
            }
        }

        // Control functions
        window.nextClient = function() {
            if (!isLoggedIn) return;
            
            const newNumber = (currentClinic.currentNumber || 0) + 1;
            updateClinicNumber(newNumber);
            callNumber(newNumber);
            showNotification(`تم الانتقال إلى العميل رقم ${newNumber}`);
        };

        window.previousClient = function() {
            if (!isLoggedIn) return;
            
            const newNumber = Math.max(0, (currentClinic.currentNumber || 0) - 1);
            updateClinicNumber(newNumber);
            callNumber(newNumber);
            showNotification(`تم الرجوع إلى العميل رقم ${newNumber}`);
        };

        window.repeatCall = function() {
            if (!isLoggedIn) return;
            
            const currentNumber = currentClinic.currentNumber || 0;
            if (currentNumber > 0) {
                callNumber(currentNumber);
                showNotification(`تم تكرار نداء العميل رقم ${currentNumber}`);
            }
        };

        window.resetClinic = function() {
            if (!isLoggedIn) return;
            
            if (confirm('هل أنت متأكد من تصفير العيادة؟')) {
                updateClinicNumber(0);
                showNotification('تم تصفير العيادة');
            }
        };

        window.callSpecificNumber = function() {
            if (!isLoggedIn) return;
            
            const number = prompt('أدخل رقم العميل:');
            if (number && !isNaN(number) && number > 0) {
                updateClinicNumber(parseInt(number));
                callNumber(parseInt(number));
                showNotification(`تم نداء العميل رقم ${number}`);
            }
        };

        window.callByName = function() {
            if (!isLoggedIn) return;
            
            const name = document.getElementById('clientName').value;
            if (name) {
                const callData = {
                    type: 'byName',
                    name: name,
                    clinicId: currentClinicId,
                    clinicName: currentClinic.name,
                    message: `نداء للعميل ${name} للتوجه إلى ${currentClinic.name}`,
                    timestamp: new Date().toISOString()
                };
                
                const callsRef = ref(database, 'calls');
                push(callsRef, callData);
                
                showNotification(`تم نداء العميل ${name}`);
                document.getElementById('clientName').value = '';
            }
        };

        window.transferClient = function() {
            if (!isLoggedIn) return;
            
            const number = document.getElementById('transferNumber').value;
            const targetClinicId = document.getElementById('targetClinic').value;
            
            if (number && targetClinicId) {
                // Fetch target clinic name for message
                get(ref(database, `clinics/${targetClinicId}`)).then(snapshot => {
                    const targetClinic = snapshot.val();
                    const targetClinicName = targetClinic ? targetClinic.name : 'عيادة مجهولة';

                    const transferData = {
                        type: 'transfer',
                        number: parseInt(number),
                        fromClinic: currentClinicId,
                        toClinic: targetClinicId,
                        message: `تحويل للعميل رقم ${number} من ${currentClinic.name} إلى ${targetClinicName}`,
                        timestamp: new Date().toISOString()
                    };
                    
                    const transfersRef = ref(database, 'transfers');
                    push(transfersRef, transferData);
                    
                    showNotification(`تم تحويل العميل رقم ${number} إلى ${targetClinicName}`);
                    document.getElementById('transferNumber').value = '';
                    document.getElementById('targetClinic').value = '';
                });
            }
        };

        window.sendDoctorAlert = function() {
            if (!isLoggedIn) return;
            
            const targetClinic = document.getElementById('targetDoctorClinic').value;
            const message = document.getElementById('doctorMessage').value;
            
            if (targetClinic && message) {
                const alertData = {
                    type: 'doctorAlert',
                    fromClinic: currentClinicId,
                    toClinic: targetClinic,
                    message: message,
                    timestamp: new Date().toISOString()
                };
                
                const alertsRef = ref(database, 'alerts');
                push(alertsRef, alertData);
                
                showNotification(`تم إرسال تنبيه إلى الطبيب في العيادة المستهدفة`);
                document.getElementById('doctorMessage').value = '';
                document.getElementById('targetDoctorClinic').value = '';
            }
        };

        window.emergencyAlert = function() {
            if (!isLoggedIn) return;
            
            const emergencyData = {
                type: 'emergency',
                clinicId: currentClinicId,
                clinicName: currentClinic.name,
                message: `نداء طوارئ من عيادة ${currentClinic.name}`,
                timestamp: new Date().toISOString()
            };
            
            const emergenciesRef = ref(database, 'emergencies');
            push(emergenciesRef, emergencyData);
            
            showNotification('تم إرسال تنبيه طوارئ إلى جميع الشاشات');
        };

        window.pauseClinic = function() {
            if (!isLoggedIn) return;
            
            const clinicRef = ref(database, `clinics/${currentClinicId}/isActive`);
            set(clinicRef, false);
            showNotification('تم إيقاف العيادة مؤقتاً');
        };

        window.resumeClinic = function() {
            if (!isLoggedIn) return;
            
            const clinicRef = ref(database, `clinics/${currentClinicId}/isActive`);
            set(clinicRef, true);
            showNotification('تم استئناف عمل العيادة');
        };

        // Utility functions
        function updateClinicNumber(newNumber) {
            const clinicRef = ref(database, `clinics/${currentClinicId}`);
            const updateData = {
                currentNumber: newNumber,
                lastCalled: new Date().toISOString()
            };
            
            set(clinicRef, { ...currentClinic, ...updateData });
        }

        function callNumber(number) {
            const callData = {
                type: 'normal',
                number: number,
                clinicId: currentClinicId,
                clinicName: currentClinic.name,
                message: `على العميل رقم ${number} التوجه إلى ${currentClinic.name}`,
                timestamp: new Date().toISOString()
            };
            
            const callsRef = ref(database, 'calls');
            push(callsRef, callData);
            
            // Play sound
            playCallSound(number);
        }

        // Updated playCallSound function
        async function playCallSound(number) {
            const audio = document.getElementById('audioPlayer');
            if (!audio) {
                console.error('Audio player not found.');
                return;
            }

            const numberAudioPath = `${audioPath}/${number}.mp3`;
            const clinicAudioPath = `${audioPath}/clinic${currentClinicId}.mp3`;
            const dingAudioPath = `${audioPath}/ding.mp3`;

            // Fallback to TTS
            const fallbackToTTS = (message) => {
                 if ('speechSynthesis' in window) {
                    const utterance = new SpeechSynthesisUtterance(message);
                    utterance.lang = 'ar-SA';
                    utterance.rate = speechRate;
                    speechSynthesis.speak(utterance);
                }
            };
            
            const numberMessage = `على العميل رقم ${number}`;
            const clinicMessage = `التوجه إلى ${currentClinic.name}`;

            const playNext = (path, fallbackMessage) => new Promise((resolve) => {
                if (!path) return resolve();
                
                audio.src = path;
                audio.onended = resolve;
                audio.onerror = () => {
                     console.error(`Error loading audio: ${path}. Falling back to TTS.`);
                     if (fallbackMessage) fallbackToTTS(fallbackMessage);
                     resolve();
                };
                
                audio.play().catch(e => {
                    console.error(`Playback failed for ${path}:`, e);
                    if (fallbackMessage) fallbackToTTS(fallbackMessage);
                    resolve();
                });
            });

            // Sequence playback: Ding -> Number -> Clinic Name
            await playNext(dingAudioPath, ''); 
            await playNext(numberAudioPath, numberMessage);
            await playNext(clinicAudioPath, clinicMessage);
        }

        function showNotification(message) {
            const notification = document.getElementById('notification');
            const notificationText = document.getElementById('notificationText');
            
            notificationText.textContent = message;
            notification.classList.add('show');
            
            setTimeout(() => {
                notification.classList.remove('show');
            }, 3000);
        }

        function updateDateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleTimeString('ar-EG');
            document.getElementById('currentDate').textContent = now.toLocaleDateString('ar-EG', {
                weekday: 'long',
                year: 'numeric',
                month: 'long',
                day: 'numeric'
            });
        }

        window.logout = function() {
            if (confirm('هل أنت متأكد من الخروج؟')) {
                currentClinicId = null;
                currentClinic = null;
                isLoggedIn = false;
                
                document.getElementById('loginModal').style.display = 'flex';
                document.getElementById('mainContent').style.display = 'none';
                
                // Reset form
                document.getElementById('clinicSelect').value = '';
                document.getElementById('controlPassword').value = '';
            }
        };

        // Initialize
        loadClinicsForLogin();
    </script>
</body>
</html>
